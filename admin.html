<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ê´€ë¦¬ì ì—…ë¡œë“œ Â· ìš°ë¦¬ë°©</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    :root { --muted:#aab3c2; --txt:#f1f4fb; --glass:rgba(13,16,24,.72);}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans KR',sans-serif;
      color:var(--txt);
      background:
        linear-gradient(180deg, rgba(0,0,0,.55), rgba(10,12,18,.88)),
        url('./bg.png') center/cover fixed no-repeat;
      min-height:100vh;
    }
    .wrap{max-width:980px;margin:0 auto;padding:22px}
    .brand{
      background:var(--glass); border:1px solid rgba(255,255,255,.08);
      border-radius:18px; padding:16px; backdrop-filter: blur(10px);
    }
    h1{margin:0;font-size:18px}
    .sub{color:var(--muted);font-size:13px;margin-top:6px;line-height:1.5}
    .panel{margin-top:14px;background:var(--glass);border:1px solid rgba(255,255,255,.08);border-radius:18px;padding:14px;backdrop-filter: blur(10px);}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input[type="file"]{background:rgba(12,16,28,.92);color:var(--txt);border:1px solid rgba(255,255,255,.10);border-radius:12px;padding:10px}
    .btn{cursor:pointer;background:rgba(26,35,56,.9);border:1px solid rgba(255,255,255,.10);border-radius:12px;padding:10px 12px;color:var(--txt);font-size:14px;text-decoration:none}
    .btn:hover{filter:brightness(1.06)}
    textarea{width:100%;min-height:120px;background:rgba(12,16,28,.92);color:var(--txt);border:1px solid rgba(255,255,255,.10);border-radius:12px;padding:12px;font-size:12px}
    .hint{color:var(--muted);font-size:12px;margin-top:10px;line-height:1.55}
    code{background:rgba(12,16,28,.92);border:1px solid rgba(255,255,255,.10);padding:2px 6px;border-radius:8px}
    .ok{color:#b7ffcc}
    .bad{color:#ffb7b7}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="brand">
      <h1>ê´€ë¦¬ì ì—…ë¡œë“œ</h1>
      <div class="sub">
        ì—‘ì…€(<b>.xlsx</b>) ë˜ëŠ” CSV(<b>.csv</b>)ë¥¼ ì—…ë¡œë“œí•˜ë©´ <b>ê³µìœ  ë§í¬</b>ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.<br/>
        ìƒì„±ëœ ë§í¬ë¥¼ ì—´ë©´ <code>index.html</code>ì—ì„œ ì—…ë¡œë“œ ë°ì´í„°ê°€ ê·¸ëŒ€ë¡œ í‘œì‹œë©ë‹ˆë‹¤. (ì„œë²„ ì €ì¥ ì—†ìŒ)
      </div>
    </div>

    <div class="panel">
      <div class="row">
        <input id="file" type="file" accept=".xlsx,.csv,text/csv,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" />
        <button class="btn" id="make">ê³µìœ  ë§í¬ ë§Œë“¤ê¸°</button>
        <button class="btn" id="tpl">CSV í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œ</button>
        <a class="btn" href="./index.html">ì¡°íšŒ í˜ì´ì§€ë¡œ</a>
      </div>

      <div class="hint">
        âœ… í•„ìˆ˜ ì»¬ëŸ¼(ì˜ë¬¸ ê¸°ì¤€): <code>nickname</code>, <code>birth</code>, <code>city</code>, <code>gender</code><br/>
        âœ… ì—‘ì…€(í•œê¸€ í—¤ë”)ë„ ìë™ ì¸ì‹í•©ë‹ˆë‹¤: ë‹‰ë„´/ìƒë…„/ì‚¬ëŠ”ê³³/ì„±ë³„/MBTI/ì»¤í”Œì†”ë¡œ/ì·¨ë¯¸/ì„ í˜¸ì•ˆì£¼/íŠ¹ì§•/ì§ì¥ ë“±<br/>
        <span id="status"></span>
      </div>

      <div class="hint" style="margin-top:14px;">ğŸ”— ìƒì„±ëœ ê³µìœ  ë§í¬</div>
      <textarea id="out" readonly placeholder="ì—¬ê¸°ì— ë§í¬ê°€ ìƒì„±ë©ë‹ˆë‹¤"></textarea>
      <div class="row" style="margin-top:10px;">
        <button class="btn" id="copy">ë§í¬ ë³µì‚¬</button>
        <button class="btn" id="open">ë§í¬ ì—´ê¸°</button>
      </div>

      <div class="hint" style="margin-top:14px;">
        ğŸ’¡ â€œì •ì‹ ë°ì´í„°ë¡œ ì˜êµ¬ ë°˜ì˜â€í•˜ë ¤ë©´ GitHubì—ì„œ <code>data.csv</code> íŒŒì¼ì„ êµì²´í•´ ì£¼ì„¸ìš”.<br/>
        (repo â†’ Add file â†’ Upload files â†’ data.csv ë®ì–´ì“°ê¸°)
      </div>
    </div>
  </div>

<script>
  const REQUIRED = ["nickname","birth","city","gender"];

  function norm(s){ return (s ?? "").toString().trim(); }

  // UTF-8 safe base64
  function encodeB64Utf8(str){
    const bytes = new TextEncoder().encode(str);
    let bin=""; bytes.forEach(b=>bin+=String.fromCharCode(b));
    return btoa(bin);
  }

  function parseCSV(file){
    return new Promise((resolve,reject)=>{
      Papa.parse(file, {
        header: true,
        skipEmptyLines: true,
        complete: (res)=> resolve(res.data),
        error: reject
      });
    });
  }

  function parseXLSX(file){
    return new Promise((resolve,reject)=>{
      const reader = new FileReader();
      reader.onload = (e)=>{
        try{
          const data = new Uint8Array(e.target.result);
          const wb = XLSX.read(data, {type:"array"});
          const ws = wb.Sheets[wb.SheetNames[0]];
          const json = XLSX.utils.sheet_to_json(ws, {defval:""});
          resolve(json);
        }catch(err){ reject(err); }
      };
      reader.onerror = reject;
      reader.readAsArrayBuffer(file);
    });
  }

  function toFullYear(v){
    const s = norm(v);
    if(!s) return "";
    const n = parseInt(s,10);
    if(Number.isNaN(n)) return s;
    if(n < 100){
      // ê¸°ë³¸: 85~97ì€ 1900së¡œ, ê·¸ ì™¸ëŠ” 2000së¡œ
      return String(n >= 50 ? 1900 + n : 2000 + n);
    }
    return String(n);
  }

  function inferRegion(place){
    const p = norm(place);
    if(!p) return "";
    if(p.includes("ì¸ì²œ")) return "ì¸ì²œ";
    const incheon = ["ì¤‘êµ¬","ë™êµ¬","ë¯¸ì¶”í™€","ì—°ìˆ˜","ë‚¨ë™","ë¶€í‰","ê³„ì–‘","ì„œêµ¬","ê°•í™”","ì˜¹ì§„"];
    const gg = ["ë¶€ì²œ","ì•ˆì–‘","ì‹œí¥","ê´‘ëª…","ê¹€í¬","ê³ ì–‘","íŒŒì£¼","ì˜ì •ë¶€","ì„±ë‚¨","ìˆ˜ì›","ìš©ì¸","ì•ˆì‚°","ê³¼ì²œ","í•˜ë‚¨","ë‚¨ì–‘ì£¼","ì–‘ì£¼","ë™ë‘ì²œ","í¬ì²œ","êµ¬ë¦¬","êµ°í¬","ì˜ì™•","í™”ì„±","í‰íƒ","ì´ì²œ","ì—¬ì£¼","ì˜¤ì‚°","ì–‘í‰","ê°€í‰","ì—°ì²œ"];
    const seoul = ["ì¢…ë¡œ","ì¤‘êµ¬","ìš©ì‚°","ì„±ë™","ê´‘ì§„","ë™ëŒ€ë¬¸","ì¤‘ë‘","ì„±ë¶","ê°•ë¶","ë„ë´‰","ë…¸ì›","ì€í‰","ì„œëŒ€ë¬¸","ë§ˆí¬","ì–‘ì²œ","ê°•ì„œ","êµ¬ë¡œ","ê¸ˆì²œ","ì˜ë“±í¬","ë™ì‘","ê´€ì•…","ì„œì´ˆ","ê°•ë‚¨","ì†¡íŒŒ","ê°•ë™"];
    const p2 = p.replace(/(ì‹œ|êµ¬)$/,"");
    if(incheon.includes(p2)) return "ì¸ì²œ";
    if(gg.includes(p2)) return "ê²½ê¸°";
    if(seoul.includes(p2)) return "ì„œìš¸";
    return "ì„œìš¸";
  }

  function inferDistrict(place, region){
    const p = norm(place);
    if(!p) return "";
    const seoul = ["ì¢…ë¡œ","ì¤‘êµ¬","ìš©ì‚°","ì„±ë™","ê´‘ì§„","ë™ëŒ€ë¬¸","ì¤‘ë‘","ì„±ë¶","ê°•ë¶","ë„ë´‰","ë…¸ì›","ì€í‰","ì„œëŒ€ë¬¸","ë§ˆí¬","ì–‘ì²œ","ê°•ì„œ","êµ¬ë¡œ","ê¸ˆì²œ","ì˜ë“±í¬","ë™ì‘","ê´€ì•…","ì„œì´ˆ","ê°•ë‚¨","ì†¡íŒŒ","ê°•ë™"];
    if(region === "ì„œìš¸"){
      const p2 = p.replace(/êµ¬$/,"");
      if(seoul.includes(p2)) return p2 + "êµ¬";
    }
    return "";
  }

  function mapRow(r){
    // í•œê¸€ í—¤ë” â†’ í‘œì¤€ ì˜ë¬¸ í‚¤ë¡œ ë§¤í•‘
    // ê°€ëŠ¥í•œ í•œ ë§ì´ í¡ìˆ˜í•˜ë„ë¡ ì—¬ëŸ¬ í›„ë³´ë¥¼ ë‘ 
    const nickname = norm(r.nickname || r.ë‹‰ë„´ || r.ë‹‰ë„¤ì„ || r.name || r.ì´ë¦„);
    const birthRaw = r.birth || r.ìƒë…„ || r.ì¶œìƒ || r.ì¶œìƒë…„ë„ || r.ë‚˜ì´;
    const place = norm(r.city || r.ì‚¬ëŠ”ê³³ || r.ê±°ì£¼ì§€ || r.ì§€ì—­ || r.ë™ë„¤);
    const gender = norm(r.gender || r.ì„±ë³„);
    const mbti = norm(r.mbti || r.MBTI).toUpperCase();
    const status = norm(r.status || r.ì»¤í”Œì†”ë¡œ || r.ì»¤í”Œ || r.ì†”ë¡œ);
    const interests = norm(r.interests || r["ì·¨ë¯¸/ê´€ì‹¬ì‚¬"] || r.ì·¨ë¯¸ || r.ê´€ì‹¬ì‚¬);
    const want_meet = norm(r.want_meet || r["ì„ í˜¸ì•ˆì£¼/ìˆ "] || r.ì„ í˜¸ì•ˆì£¼ || r.ì„ í˜¸ìˆ  || r.ì•ˆì£¼ || r.ìˆ );
    const notes = norm(r.notes || r.íŠ¹ì§• || r.ë©”ëª¨);
    const work = norm(r.work || r.ì§ì¥ || r.íšŒì‚¬ || r.ì†Œì†);

    const region = inferRegion(place);
    const district = inferDistrict(place, region);

    return {
      nickname,
      birth: toFullYear(birthRaw),
      city: region,
      district,
      gender,
      mbti,
      status,
      interests,
      want_meet,
      notes,
      work
    };
  }

  function validate(rows){
    if(!rows.length) return {ok:false, msg:"ë°ì´í„°ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤."};
    const keys = Object.keys(rows[0]).map(k=>k.trim());
    const missing = REQUIRED.filter(k=>!keys.includes(k));
    if(missing.length) return {ok:false, msg:`í•„ìˆ˜ ì»¬ëŸ¼ ëˆ„ë½: ${missing.join(", ")}`};
    return {ok:true};
  }

  function makeLink(rows){
    const json = JSON.stringify(rows);
    const b64 = encodeB64Utf8(json);
    const base = location.origin + location.pathname.replace(/admin\.html$/,"index.html");
    return base + "#data=" + encodeURIComponent(b64);
  }

  function downloadTemplate(){
    const header = ["nickname","birth","city","district","gender","mbti","status","interests","want_meet","notes","work"].join(",");
    const sample = [
      "ìƒˆë²½,1991,ì¸ì²œ,ë¶€í‰êµ¬,ì—¬,ISTP,ì†”ë¡œ,ìˆ /ë§›ì§‘/ìˆ˜ë‹¤,ì„œë¶€ê¶Œ í•œì”,ë°©ì¥,ì¤‘êµ¬",
      "ëª¨ë…¸,1989,ì„œìš¸,ì˜ë“±í¬êµ¬,ë‚¨,ENFP,ì†”ë¡œ,ìœ„ìŠ¤í‚¤/ì•ˆì£¼,í‡´ê·¼í›„ ë²ˆê°œ,ë¶€ë°©ì¥,ì˜ë“±í¬"
    ].join("\n");
    const blob = new Blob([header + "\n" + sample], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = "ourbang_template.csv";
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  }

  async function build(){
    const f = document.getElementById("file").files[0];
    if(!f){ alert("íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš” (.xlsx ë˜ëŠ” .csv)"); return; }

    let raw=[];
    try{
      if(f.name.toLowerCase().endsWith(".xlsx")){
        raw = await parseXLSX(f);
      }else{
        raw = await parseCSV(f);
      }
    }catch(e){
      alert("íŒŒì¼ ì½ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (ì—‘ì…€/CSV í˜•ì‹ì„ í™•ì¸í•´ì£¼ì„¸ìš”)");
      return;
    }

    const mapped = raw.map(mapRow).filter(r => norm(r.nickname));
    const v = validate(mapped);
    const st = document.getElementById("status");
    if(!v.ok){
      st.innerHTML = `<span class="bad">âŒ ${v.msg}</span>`;
      alert(v.msg);
      return;
    }
    st.innerHTML = `<span class="ok">âœ… ${mapped.length}ëª… ë³€í™˜ ì™„ë£Œ</span>`;

    const link = makeLink(mapped);
    document.getElementById("out").value = link;
  }

  document.getElementById("tpl").addEventListener("click", downloadTemplate);
  document.getElementById("make").addEventListener("click", build);

  document.getElementById("copy").addEventListener("click", async ()=>{
    const t = document.getElementById("out").value.trim();
    if(!t){ alert("ë¨¼ì € ê³µìœ  ë§í¬ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”."); return; }
    try{
      await navigator.clipboard.writeText(t);
      alert("ë§í¬ë¥¼ ë³µì‚¬í–ˆìŠµë‹ˆë‹¤!");
    }catch(e){
      const out = document.getElementById("out");
      out.focus(); out.select();
      document.execCommand("copy");
      alert("ë§í¬ë¥¼ ë³µì‚¬í–ˆìŠµë‹ˆë‹¤!");
    }
  });

  document.getElementById("open").addEventListener("click", ()=>{
    const t = document.getElementById("out").value.trim();
    if(!t){ alert("ë¨¼ì € ê³µìœ  ë§í¬ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”."); return; }
    window.open(t, "_blank");
  });
</script>
</body>
</html>
